{% extends 'base.html' %}
{% load static %}

{% block title %}
<title>PeaceMindAI | Chat</title>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<section class="relative py-20 overflow-hidden">
    <!-- Animated background gradient -->
    <div class="absolute inset-0 bg-gradient-to-br from-primary/20 via-secondary/20 to-accent/20 dark:from-primary/10 dark:via-secondary/10 dark:to-accent/10 animate-gradient"></div>
    
    <!-- Decorative elements -->
    <div class="absolute inset-0 overflow-hidden">
        <div class="absolute -top-40 -right-40 w-80 h-80 bg-primary/10 rounded-full blur-3xl"></div>
        <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-accent/10 rounded-full blur-3xl"></div>
    </div>

    <div class="container mx-auto px-4 relative z-10">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-4xl md:text-5xl font-bold mb-6 bg-clip-text text-transparent bg-gradient-to-r from-primary to-accent animate-gradient-x">
                    Chat with PeaceMindAI
                </h1>
                <p class="text-lg text-gray-600 dark:text-gray-300">
                    Share your thoughts, feelings, or concerns. I'm here to listen and help.
                </p>
            </div>

            <!-- Chat Container -->
            <div class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-sm rounded-2xl shadow-lg border border-gray-100 dark:border-gray-700 overflow-hidden">
                <!-- Chat Messages Container -->
                <div id="chat-messages" class="h-[60vh] md:h-[500px] overflow-y-auto bg-gray-50 dark:bg-gray-900/50">
                    <div id="messages-container" class="flex flex-col gap-4 p-4 md:p-6">
                        <!-- Welcome message -->
                        <div class="flex justify-start">
                            <div class="max-w-[75%] bg-primary text-white rounded-2xl px-4 py-3 shadow-sm">
                                Hello! I'm PeaceMindAI, your AI companion for mental wellness. How can I help you today?
                            </div>
                        </div>

                        <!-- Chat History -->
                        {% for message in chat_history reversed %}
                        <div class="flex justify-end">
                            <div class="max-w-[75%] bg-accent text-white rounded-2xl px-4 py-3 shadow-sm">
                                {{ message.message }}
                            </div>
                        </div>
                        <div class="flex justify-start">
                            <div class="max-w-[75%] bg-primary text-white rounded-2xl px-4 py-3 shadow-sm">
                                {{ message.response }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Loading Indicator -->
                <div id="loading-indicator" class="hidden p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                    <div class="flex items-center space-x-3">
                        <div class="animate-pulse flex space-x-2">
                            <div class="h-2 w-2 bg-primary rounded-full"></div>
                            <div class="h-2 w-2 bg-primary rounded-full"></div>
                            <div class="h-2 w-2 bg-primary rounded-full"></div>
                        </div>
                        <span class="text-sm text-gray-500 dark:text-gray-400">PeaceMindAI is thinking...</span>
                    </div>
                </div>

                <!-- Chat Input Form -->
                <div class="p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800">
                    <form id="chat-form" class="flex space-x-4">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class='bx bx-message-square-detail text-primary/60 dark:text-primary/40'></i>
                            </div>
                            <input
                                type="text"
                                id="message-input"
                                class="pl-10 appearance-none block w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
                                placeholder="Type your message here..."
                                autocomplete="off"
                            />
                        </div>
                        <button
                            type="submit"
                            id="send-button"
                            class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-accent focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transform hover:scale-105 transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <i class='bx bx-send mr-2'></i>
                            Send
                        </button>
                    </form>
                </div>

                <!-- Connection Status -->
                <div id="connection-status" class="hidden">
                    <div class="p-4 bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400 text-center">
                        <p class="text-sm font-medium">
                            Connection lost. Attempting to reconnect...
                        </p>
                        <button
                            id="retry-connection"
                            class="mt-2 px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transform hover:scale-105 transition-all duration-300"
                        >
                            Retry Now
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Add custom styles -->
<style>
    @keyframes gradient-x {
        0%, 100% {
            background-position: 0% 50%;
        }
        50% {
            background-position: 100% 50%;
        }
    }
    
    .animate-gradient-x {
        background-size: 200% 200%;
        animation: gradient-x 15s ease infinite;
    }
    
    .animate-gradient {
        animation: gradient-x 20s ease infinite;
    }

    /* Custom scrollbar styles */
    #chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    #chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }

    #chat-messages::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 3px;
    }

    #chat-messages::-webkit-scrollbar-thumb:hover {
        background-color: rgba(156, 163, 175, 0.7);
    }

    .dark #chat-messages::-webkit-scrollbar-thumb {
        background-color: rgba(75, 85, 99, 0.5);
    }

    .dark #chat-messages::-webkit-scrollbar-thumb:hover {
        background-color: rgba(75, 85, 99, 0.7);
    }
</style>

<script>
    let chatSocket = null;
    let reconnectAttempts = 0;
    const MAX_RECONNECT_ATTEMPTS = 5;
    const RECONNECT_DELAY = 2000; // 2 seconds

    const messagesList = document.getElementById("chat-messages");
    const messageForm = document.getElementById("chat-form");
    const messageInput = document.getElementById("message-input");
    const loadingIndicator = document.getElementById("loading-indicator");
    const connectionStatus = document.getElementById("connection-status");
    const sendButton = document.getElementById("send-button");
    const retryButton = document.getElementById("retry-connection");

    function appendMessage(message, isUser = false) {
        const messageContainer = document.createElement("div");
        messageContainer.className = "flex " + (isUser ? "justify-end" : "justify-start");

        const bubbleDiv = document.createElement("div");
        bubbleDiv.className = isUser
            ? "max-w-[75%] bg-accent text-white rounded-2xl px-4 py-3 shadow-sm"
            : "max-w-[75%] bg-primary text-white rounded-2xl px-4 py-3 shadow-sm";
        bubbleDiv.textContent = message;

        messageContainer.appendChild(bubbleDiv);

        const messagesContainer = document.getElementById("messages-container");
        messagesContainer.appendChild(messageContainer);

        // Force scroll to bottom
        const chatContainer = document.getElementById("chat-messages");
        requestAnimationFrame(() => {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        });
    }

    function showError(message) {
        const errorDiv = document.createElement("div");
        errorDiv.className = "flex justify-center my-2";

        const errorContent = document.createElement("div");
        errorContent.className = "bg-red-100 dark:bg-red-900/50 text-red-600 dark:text-red-400 px-4 py-2 rounded-lg text-sm";
        errorContent.textContent = message;

        errorDiv.appendChild(errorContent);
        messagesList.appendChild(errorDiv);
        messagesList.scrollTop = messagesList.scrollHeight;
    }

    function setLoading(isLoading) {
        loadingIndicator.classList.toggle("hidden", !isLoading);
        messageInput.disabled = isLoading;
        sendButton.disabled = isLoading;
    }

    function updateConnectionStatus(isConnected) {
        connectionStatus.classList.toggle("hidden", isConnected);
        messageInput.disabled = !isConnected;
        sendButton.disabled = !isConnected;

        if (!isConnected) {
            loadingIndicator.classList.add("hidden");
        }
    }

    function connect() {
        try {
            const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
            const wsUrl = `${wsScheme}://${window.location.host}/ws/chat/`;

            chatSocket = new WebSocket(wsUrl);

            chatSocket.onopen = function () {
                updateConnectionStatus(true);
                reconnectAttempts = 0;
            };

            chatSocket.onmessage = function (e) {
                const data = JSON.parse(e.data);

                if (data.type === "error") {
                    showError(data.message);
                } else if (data.type === "chat") {
                    appendMessage(data.message, false);
                }
                setLoading(false);
            };

            chatSocket.onclose = function () {
                updateConnectionStatus(false);

                if (reconnectAttempts < MAX_RECONNECT_ATTEMPTS) {
                    reconnectAttempts++;
                    setTimeout(connect, RECONNECT_DELAY * reconnectAttempts);
                } else {
                    showError("Unable to establish connection. Please refresh the page.");
                }
            };

            chatSocket.onerror = function (e) {
                showError("Connection error occurred. Please try again.");
                updateConnectionStatus(false);
            };
        } catch (error) {
            showError("Failed to establish connection. Please try refreshing the page.");
            updateConnectionStatus(false);
        }
    }

    retryButton.addEventListener("click", function () {
        if (chatSocket) {
            chatSocket.close();
        }
        reconnectAttempts = 0;
        connect();
    });

    messageForm.addEventListener("submit", function (e) {
        e.preventDefault();
        const message = messageInput.value.trim();

        if (message && chatSocket && chatSocket.readyState === WebSocket.OPEN) {
            try {
                appendMessage(message, true);
                setLoading(true);

                chatSocket.send(
                    JSON.stringify({
                        message: message,
                    })
                );

                messageInput.value = "";
            } catch (error) {
                showError("Failed to send message. Please try again.");
                setLoading(false);
            }
        } else if (!chatSocket || chatSocket.readyState !== WebSocket.OPEN) {
            showError("Not connected to chat server. Please wait for reconnection.");
        }
    });

    messageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            messageForm.dispatchEvent(new Event("submit"));
        }
    });

    // Initial connection
    connect();
</script>
{% endblock %}
